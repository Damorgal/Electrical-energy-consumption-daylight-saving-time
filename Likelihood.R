#-------------------------------------------------------------------------------
#------------------------------M?todos estad?sticos-----------------------------
#-----------------------------------Proyecto--------------------------------------
#---------------------------Diego Aar?n Moreno Galv?n---------------------------

#--------------------------------Funciones--------------------------------------

# Funci?n de log-verosimilitud para Normal
l<-function(mu, sigma, t1, t2, n){ 
  	term1 = -n*log(sigma)
 	term2 = -t2/(2*sigma*sigma)
  	term3 = mu*t1/(sigma*sigma)
  	term4 = -n*mu*mu/(2*sigma*sigma)
  	return(term1 + term2 + term3 + term4)
}

# Funci?n de log-verosimilitud relativa
r<- function(mu, sigma, t1, t2, n){ 
  	mu_gorro = t1/n
  	sigma_gorro = sqrt((t2/n) - ((t1^2)/(n^2)))
  	return(l(mu, sigma, t1, t2, n) - l(mu_gorro, sigma_gorro, t1, t2, n))
}

# Funci?n de verosimilitud
L<- function(mu, sigma, t1, t2, n){ 
  	return(exp(l(mu,sigma,t1, t2, n)))
}

#Funci?n de verosimilitud relativa
R<- function(mu, sigma, t1, t2, n){ 
  	return(exp(r(mu,sigma, t1, t2, n)))
}

#Funci?n que devuelve el sigma que maximiza la funci?n para mu
Sigma_gorro<- function(mu, t1, t2, n){ 
  	return(sqrt((t2-2*mu*t1+n*mu*mu)/n))
}

#Funci?n que devuelve el mu que maximiza la funci?n para sigma
Mu_gorro<- function(sigma, t1, t2, n){
  	return((t1/n)*(sigma/sigma)) #Se multiplica por sigma/sigma s?lo para que devuelva un vector cuando sigma es un vector
}

#Funci?n de Logverosimilitud perfil de la media theta de una normal
lp_norm <- function(theta,t1,t2,n)	{
	a1 = (t2-2*theta*t1+n*theta^2)/n
	a2 = log(a1)+1
	return ((-n/2)*a2)
}

#Funci?n de Logver. perfil relativa de theta de una normal
rp_norm <- function(theta,t1,t2,n)	{
	return (lp_norm(theta,t1,t2,n) - lp_norm(t1/n,t1,t2,n))
}

#Funci?n de verosimilitud perfil realtiva de theta de una normal
Rp_norm <- function(theta,t1,t2,n)	{
	return (exp(rp_norm(theta,t1,t2,n)))
}

#Funci?n de distribuci?n de t de student con k grad. de lib.
Ft <- function(x,k)	{
	return (pt(x, k, lower.tail = T, log.p = F))
}

#Funci?n que devuelve el cuartil de prob. p de una t de student de k
Q <- function(p,k)	{
	return (qt(p, k, lower.tail = T, log.p = F))
}

#Funci?n que calcula el nivel de verosimilitud c
C <- function(n, alfa)	{
	t1 = Q(alfa/2, n-1)^2
	t2 = t1/(n-1)
	return ((t2+1)^(-n/2))
}

#Funci?n que devuelve la confianza (probabilidad) de un intervalo de verosi.
Confianza <- function(n,nivel)	{
	t1 = Ft(((n-1)*(nivel^(-2/n)-1))^(1/2), n-1)
	t2 = Ft(-((n-1)*(nivel^(-2/n)-1))^(1/2), n-1)
	return (t1-t2)
}


#Funci?n de Logverosimilitud perfil de la varianza de una normal
lp_var_norm <- function(sigma,t1,t2,n)	{
	H = (t2-t1^2/n)
	a1 = n*log(sigma)
	a2 = H/(2*sigma^2)
	return (-a1-a2)
}

#Funci?n de Logver. perfil relativa de la varianza de una normal
rp_var_norm <- function(sigma,t1,t2,n)	{
	sg = ((t2-t1^2/n)/n)^(1/2)
	return (lp_var_norm(sigma,t1,t2,n) - lp_var_norm(sg,t1,t2,n))
}

#Funci?n de verosimilitud perfil realtiva de la varianza de una normal
Rp_var_norm <- function(sigma,t1,t2,n)	{
	return (exp(rp_var_norm(sigma,t1,t2,n)))
}

#Funci?n que calcula el nivel de verosimilitud c
C_var <- function(n, alfa)	{
	q = qchisq(alfa/2, n-1, lower.tail = T, log.p = F)
	t1 = (27*q*n^(1/2))^(1/3)
	t2 = (-1/4)*(3*n^(1/2)-t1)^2
	return (exp(t2))
}

Confianza_var <- function(n,c)	{
	t1 = (3*n^(1/2)+(-4*log(c))^(1/2))^3/(27*n^(1/2))
	t2 = (3*n^(1/2)-(-4*log(c))^(1/2))^3/(27*n^(1/2))
	t1 = pchisq(t1,n-1,lower.tail=T,log.p=F)
	t2 = pchisq(t2,n-1,lower.tail=T,log.p=F)
	return (t1-t2)
}

Hx<- function(t1, t2, n){
  return(t2-(t1*t1/n))
}

Ky<- function(t3, t4, m){
  return(t4 - t3*t3/m)
}

rho_emv<- function(t1,t2,t3,t4,n,m){
  H= Hx(t1,t2,n)
  K= Ky(t3,t4,m)
  
  return(n*K/(m*H))
}

delta_emv<- function(t1, t2, t3, t4, n, m){
  return((t3/m)-(t1/n))
}

l1<-function(rho, t1, t2, t3, t4, n, m){
  H= Hx(t1,t2,n)
  K= Ky(t3,t4,m)
  
  return(n*log(rho)/2 - (n+m)*log(rho*H+K)/2)
}

l2<- function(delta, rho, t1, t2, t3, t4, n, m){
  delta_gorro= delta_emv(t1,t2,t3,t4,n,m)
  H= Hx(t1,t2,n)
  K= Ky(t3,t4,m)
  
  return(-(n+m)*log(1+ (n*m*(delta_gorro-delta)*(delta_gorro-delta)/((n+m/rho)*(rho*H+K))))/2)
}

lp_conjunto<- function(delta, rho, t1, t2, t3, t4, n, m){ # Logverosimilitud perfil para delta y rho
  return(l1(rho,t1,t2,t3,t4,n,m)+l2(delta,rho,t1,t2,t3,t4,n,m))
}

rp_conjunto<-function(rho, delta, t1, t2, t3,t4,n,m){ #Logverosimilitud perfil relativa para delta y rho
  delta_g= delta_emv(t1,t2,t3,t4,n,m)
  rho_g= rho_emv(t1,t2,t3,t4,n,m)
  
  return(lp_conjunto(delta,rho,t1,t2,t3,t4,n,m)-lp_conjunto(delta_g,rho_g,t1,t2,t3,t4,n,m))
}

Rp_conjunto<- function(rho, delta, t1, t2, t3, t4, n, m){#Verosimilitud perfil relativa para delta y rho
  return(exp(rp_conjunto(rho,delta,t1,t2,t3,t4,n,m)))
}

rp_rho<- function(rho, t1, t2, t3, t4, n, m){
  rho_gorro= rho_emv(t1,t2,t3,t4,n,m)
  
  return(l1(rho,t1,t2,t3,t4,n,m)- l1(rho_gorro,t1,t2,t3,t4,n,m))
}

rp_rho_0<- function(rho, t1, t2, t3, t4, n, m, c){
  return(rp_rho(rho,t1,t2,t3,t4,n,m)-c)
}

Rp_rho<- function(rho, t1, t2, t3,t4,n,m){
  return(exp(rp_rho(rho,t1,t2,t3,t4,n,m)))
}

rp_delta<- function(delta, t1, t2, t3, t4, n, m){
  resp<- c()
  
  for (i in 1:length(delta)){
    temp= optim(1, rp_conjunto, delta = delta[i], t1 = t1, t2 = t2, t3=t3, t4=t4, n = n, m=m, control = list(fnscale=-1))$value
    resp = c(resp, temp)
  }
  
  return(resp)
}

Rp_delta<- function(delta, t1, t2, t3, t4, n, m){
  return(exp(rp_delta(delta,t1,t2,t3,t4,n,m))) 
}



#######################################################################################################
#--     MUESTRAS     --#

# ULTIMA SEMANA HORARIO INVIERNO MARZO 2018
X = c(7495891,7104540,6942036,6812652,6713419,6729651,6693093,6639208,6912511,7127233,7245860,7338979,
7328129,7355726,7323133,7249348,7259550,7277468,7230829,7928045,8181400,8033854,7714514,7258927,6867044,
6648967,6572386,6521881,6562286,6670592,7054672,7524905,8175665,8676862,8922367,9118004,9263407,9351802,
9304774,9304058,9289618,9158510,8804089,9001680,9110401,8869358,8591238,8184129,7760723,7536584,7365828,
7287631,7294285,7343279,7509249,7880534,8458298,8762687,8939297,9169285,9293386,9365595,9328001,9325316,
9288900,9118805,8699562,9004729,9136752,8911294,8579734,8179033,7862683,7539194,7357216,7285069,7294089,
7286848,7517699,7778555,8283165,8644360,8840013,8989629,9077733,9045176,8952611,8910423,8950400,8774206,
8460669,8774347,8866346,8625582,8366715,7960311,7613878,7315159,7150993,7022632,6947772,6958720,6972824,
7062880,7419257,7654975,7844047,7926615,8009600,7932054,7901591,7880963,7793360,7648043,7469526,7758862,
7891433,7713470,7484117,7140829,6690731,6485796,6370068,6252743,6221238,6149316,6016096,5907157,6071793,
6336719,6424551,6436016,6494357,6492245,6415512,6338829,6320971,6270004,6254867,6629783,6883956,6746001,
6505657,6251766,5952002,5656146,5596290,5516600,5514169,5604368,5627848,5842514,6226250,6521818,6723445,
6864009,6900023,6959337,6948046,7018179,6928213,6930913,6878692,7357916,7592985,7436322,7091846,6664122)

# PRIMERA SEMANA HORARIO VERANO ABRIL 2018
Y = c(6397907,6056983,5926158,5871242,5885725,5919511,5980174,6057156,6300914,6537050,6715458,6730349,
6711681,6696652,6725232,6741488,6734360,6657978,6759730,7409971,7640542,7460061,7063249,6670356,6315524,
6213298,6189401,6212654,6331037,6788294,7354312,7823373,8327465,8636512,8843438,9022018,9089399,9055710,
9087046,9131574,8983724,8691547,8402426,8708940,8813665,8672827,8397623,7840172,7586214,7403057,7303182,
7275394,7307662,7575028,7966019,8352190,8722550,8923940,9090272,9200934,9301790,9263623,9232565,9207162,
9064469,8807387,8529098,8819556,8973652,8811980,8444135,8024746,7712778,7517321,7453651,7457063,7513469,
7736337,8091317,8500986,8879247,9096904,9212742,9320006,9413999,9320699,9292964,9296340,9161342,8893853,
8643769,8945712,9027930,8818646,8451947,7940563,7630371,7449187,7373774,7394532,7477969,7732297,8165854,
8530536,8911476,9101904,9237641,9409931,9500314,9436266,9392635,9384966,9245866,8960082,8693484,8939778,
9014336,8801597,8554423,8087004,7728260,7590364,7455913,7458393,7496963,7817371,8199424,8559006,8964246,
9147428,9293619,9399131,9393267,9366878,9309457,9308719,9073289,8774566,8470656,8733145,8879352,8753082,
8482652,8104085,7747251,7556507,7405853,7391441,7408688,7583950,7818623,8102942,8479860,8628892,8697784,
8808964,8702672,8531285,8439474,8374318,8275840,8093988,8090578,8588543,8691026,8429424,7971869)

#------------------------------------------------------------------------------------------------------------

# ULTIMO MES HORARIO INVIERNO MARZO 2018
X = c(7093741,6725595,6486893,6403181,6407903,6396814,6447924,6376442,6586366,6818364,6920305,6900230,7010024,7021356,7000475,6985360,
6949884,6976702,7057302,7737366,7953392,7798887,7469772,6991604,6640969,6348631,6264488,6225740,6244907,6480312,7014844,7529761,
8034898,8337790,8633955,8836371,8989468,9073139,8999316,8980357,9024006,8933146,8647476,8847438,9006269,8710473,8348130,8009898,
7610694,7407911,7267240,7140887,7160027,7286295,7724466,8086736,8541900,8831934,9055186,9234398,9298326,9210904,9277512,9258843,
9263399,9141946,8740007,9124615,9147917,8841781,8496985,8084362,7738760,7480236,7384955,7274271,7274044,7417039,7788204,8155646,
8583055,8897824,8949518,9036760,9183192,9220208,9125488,9148919,9187533,9014062,8695815,9002414,9056357,8776259,8400018,8028958,
7629715,7295182,7249822,7099678,7216394,7255031,7582454,7920310,8331485,8703130,8907333,9082492,9117335,9175912,9191218,9198612,
9107230,8976511,8691926,8976087,9039800,8748068,8348951,7990557,7742113,7537012,7354357,7216342,7268360,7395660,7738769,8051243,
8448749,8761477,8890628,9061711,9057536,9159277,9099636,9137311,9106302,8950738,8580172,8913201,8884753,8578220,8256820,8008073,
7558132,7221542,7075003,7058161,7049028,7138200,7354657,7580922,8027547,8398231,8441198,8621479,8696626,8611737,8395529,8262289,
8246370,8162757,8072168,8648181,8671177,8464507,8001700,7598355,7163125,6836363,6725353,6645034,6608525,6538921,6522675,6433018,
6686537,6946880,7055753,7157990,7254593,7302998,7282669,7247584,7232905,7182252,7184094,7857359,8183751,7982974,7650833,7143356,
6723415,6458740,6323141,6346873,6439979,6668521,7169313,7711239,8229040,8597507,8808678,8974726,9188081,9257705,9214763,9251293,
9276669,9114560,8754630,9027386,9082281,8790592,8467689,8030511,7650052,7380945,7259194,7150906,7197218,7254785,7642207,7919950,
8395462,8632486,8794256,9028438,9207409,9266209,9204299,9319553,9365853,9090664,8618280,8926563,9067156,8819822,8455118,8053240,
7739221,7447613,7310352,7171554,7224271,7329120,7720318,8108133,8549169,8862401,9024629,9152347,9273929,9366093,9296878,9311007,
9333464,9163386,8712439,9043948,9110923,8842492,8447510,8101035,7713375,7436421,7356685,7175669,7276069,7370426,7703260,8006825,
8463449,8814032,8916917,9034028,9183009,9264614,9154901,9139861,9135977,8929010,8654090,8870395,9013231,8701941,8426013,8079364,
7679195,7438292,7288547,7212305,7195877,7310231,7717491,8082341,8460804,8772042,8870538,9058107,9207941,9224503,9184670,9187269,
9151324,8969118,8580961,8850230,8910017,8595726,8354769,8115366,7688924,7398240,7237470,7145028,7101653,7144372,7343063,7575353,
8096509,8468467,8635543,8638344,8725485,8682050,8472919,8414450,8406987,8305317,8219389,8624832,8714601,8401857,8056358,7646014,
7250669,6940520,6766228,6644564,6552254,6548636,6525693,6397947,6683777,6947946,7081378,7192283,7207253,7120704,7042250,6982095,
7017787,6961134,7000759,7637730,7775055,7687476,7341436,6893274,6451426,6146567,6053478,6004811,5998419,6061823,6211697,6360168,
6771237,7127601,7420281,7638854,7687869,7742862,7764562,7685213,7665098,7613877,7624626,8206850,8442198,8313511,7860344,7259919,
6941444,6720718,6595603,6574393,6613030,6726859,7162079,7624718,8163179,8661124,8847420,9055291,9257949,9268843,9229059,9282757,
9267597,9078626,8809190,9045411,9119531,8897672,8497086,8198313,7765074,7515579,7356953,7298817,7236773,7421959,7827969,8122933,
8645838,8916667,8998718,9136809,9310210,9364094,9320249,9365616,9399790,9181571,8799313,9116929,9198759,8915967,8604891,8233534,
7841976,7639663,7460298,7354057,7345085,7501514,7897506,8175304,8670501,9005322,9153558,9333725,9418829,9508830,9392170,9445609,
9431424,9249604,8879691,9137228,9257622,8990597,8663707,8302462,7973223,7677861,7539059,7475283,7454518,7574129,7869631,8232847,
8700291,9026694,9157394,9305992,9477629,9474116,9353604,9365434,9375188,9193724,8819845,9014821,9119059,8843377,8561167,8298572,
7918521,7624536,7395181,7338385,7348460,7360401,7576102,7732119,8242570,8565697,8776500,8896746,8960629,8883975,8720055,8566624,
8493299,8466064,8226740,8790325,8908957,8714569,8315299,7844560,7495891,7104540,6942036,6812652,6713419,6729651,6693093,6639208,
6912511,7127233,7245860,7338979,7328129,7355726,7323133,7249348,7259550,7277468,7230829,7928045,8181400,8033854,7714514,7258927,
6867044,6648967,6572386,6521881,6562286,6670592,7054672,7524905,8175665,8676862,8922367,9118004,9263407,9351802,9304774,9304058,
9289618,9158510,8804089,9001680,9110401,8869358,8591238,8184129,7760723,7536584,7365828,7287631,7294285,7343279,7509249,7880534,
8458298,8762687,8939297,9169285,9293386,9365595,9328001,9325316,9288900,9118805,8699562,9004729,9136752,8911294,8579734,8179033,
7862683,7539194,7357216,7285069,7294089,7286848,7517699,7778555,8283165,8644360,8840013,8989629,9077733,9045176,8952611,8910423,
8950400,8774206,8460669,8774347,8866346,8625582,8366715,7960311,7613878,7315159,7150993,7022632,6947772,6958720,6972824,7062880,
7419257,7654975,7844047,7926615,8009600,7932054,7901591,7880963,7793360,7648043,7469526,7758862,7891433,7713470,7484117,7140829,
6690731,6485796,6370068,6252743,6221238,6149316,6016096,5907157,6071793,6336719,6424551,6436016,6494357,6492245,6415512,6338829,
6320971,6270004,6254867,6629783,6883956,6746001,6505657,6251766,5952002,5656146,5596290,5516600,5514169,5604368,5627848,5842514,
6226250,6521818,6723445,6864009,6900023,6959337,6948046,7018179,6928213,6930913,6878692,7357916,7592985,7436322,7091846,6664122)

#PRIMER MES HORARIO VERANO ABRIL 2018
Y = c(6397907,6056983,5926158,5871242,5885725,5919511,5980174,6057156,6300914,6537050,6715458,6730349,6711681,6696652,6725232,6741488,
6734360,6657978,6759730,7409971,7640542,7460061,7063249,6670356,6315524,6213298,6189401,6212654,6331037,6788294,7354312,7823373,
8327465,8636512,8843438,9022018,9089399,9055710,9087046,9131574,8983724,8691547,8402426,8708940,8813665,8672827,8397623,7840172,
7586214,7403057,7303182,7275394,7307662,7575028,7966019,8352190,8722550,8923940,9090272,9200934,9301790,9263623,9232565,9207162,
9064469,8807387,8529098,8819556,8973652,8811980,8444135,8024746,7712778,7517321,7453651,7457063,7513469,7736337,8091317,8500986,
8879247,9096904,9212742,9320006,9413999,9320699,9292964,9296340,9161342,8893853,8643769,8945712,9027930,8818646,8451947,7940563,
7630371,7449187,7373774,7394532,7477969,7732297,8165854,8530536,8911476,9101904,9237641,9409931,9500314,9436266,9392635,9384966,
9245866,8960082,8693484,8939778,9014336,8801597,8554423,8087004,7728260,7590364,7455913,7458393,7496963,7817371,8199424,8559006,
8964246,9147428,9293619,9399131,9393267,9366878,9309457,9308719,9073289,8774566,8470656,8733145,8879352,8753082,8482652,8104085,
7747251,7556507,7405853,7391441,7408688,7583950,7818623,8102942,8479860,8628892,8697784,8808964,8702672,8531285,8439474,8374318,
8275840,8093988,8090578,8588543,8691026,8429424,7971869,7528809,7177720,6919016,6841054,6742563,6670763,6742976,6747148,6765638,
7002221,7097629,7246035,7193788,7324622,7304711,7239559,7269558,7202732,7222245,7250789,7888037,8169502,7970725,7445027,6910439,
6654544,6556694,6498626,6532873,6683817,7233537,7851738,8214114,8582146,8819701,9072078,9198943,9227825,9168696,9228016,9294112,
9180568,8857382,8644074,8871327,8985371,8754764,8326083,7903011,7654283,7471036,7387795,7397146,7544743,7914301,8376892,8687009,
8956299,9103012,9196674,9370315,9396521,9338247,9365676,9369078,9208579,8867009,8653147,8707610,8745623,8505559,8118953,7726058,
7430637,7183679,7102203,7166445,7175640,7572537,8128754,8455601,8749897,8861380,8980051,9094805,9087973,9127787,9137516,9145104,
9060645,8684356,8435018,8685791,8674947,8382110,8045221,7686354,7389978,7219078,7134379,7135244,7274963,7621661,8097298,8406426,
8733997,8812526,8966106,9122397,9213006,9033409,9137517,9131206,9040832,8722620,8404585,8675685,8794406,8584236,8230264,7794837,
7504163,7276191,7232175,7271740,7409443,7714085,8084575,8448998,8802986,8876688,9033281,9119309,9180469,9092273,9086497,9022918,
8925690,8634265,8352965,8489604,8689018,8558001,8262648,7811059,7471699,7274191,7157972,7143387,7177042,7349157,7643034,7992868,
8360221,8467970,8690732,8772467,8714116,8451265,8311520,8238275,8156604,8023886,7956816,8453332,8556943,8230799,7744256,7345265,
6957678,6675037,6592755,6523253,6540507,6519548,6499350,6590024,6826621,6980097,7079095,7090940,7134784,7107287,7048287,7024465,
7042885,7012090,7037321,7584345,7953364,7703252,7356812,6815099,6507964,6427008,6350483,6405886,6576536,7115772,7744434,8161824,
8529473,8738104,8912885,8993773,9142671,9157786,9192940,9235399,9071541,8775647,8570895,8813171,8881186,8624047,8238060,7709101,
7515108,7462857,7311373,7300256,7397554,7767938,8271302,8573730,8828783,8967603,9156272,9325207,9355416,9348232,9376871,9435128,
9307955,9017590,8741066,8909175,9092346,8870598,8508274,7975486,7704397,7520043,7422600,7426538,7536319,7992421,8317394,8562290,
8821860,9018371,9193941,9325766,9340767,9265834,9271956,9306724,9196252,8873910,8649801,8958124,9128008,8889641,8503083,8010507,
7715912,7525044,7473972,7450314,7474715,7808520,8223029,8632417,8908780,9164388,9369501,9549354,9556511,9483500,9529418,9549279,
9358828,9020143,8812429,8986084,9095349,8894387,8577940,8074310,7792756,7609707,7536694,7561466,7655199,7998284,8412875,8810093,
9088882,9295443,9489173,9621692,9641140,9587824,9555366,9578651,9376560,9022475,8775205,8915028,9008985,8888851,8605386,8193369,
7867996,7691639,7570046,7537558,7564627,7721885,7973360,8332622,8728970,8853970,8965547,9071481,9020557,8818373,8632671,8567769,
8522413,8373604,8280605,8773004,8848501,8527582,8146997,7624502,7324177,7026617,6992444,6891460,6877441,6878353,6836488,6963145,
7154221,7319833,7412138,7421512,7389904,7405619,7313921,7315090,7290034,7259827,7292714,7924996,8142196,7961137,7552665,7165670,
6890397,6710160,6605918,6625695,6769831,7381004,7999713,8455612,8803318,9033847,9293304,9367344,9523519,9494846,9592781,9621897,
9416641,9125499,8856655,9018490,9145203,8927859,8620087,8240624,7864120,7704068,7596182,7632769,7675856,8045321,8466906,8865481,
9207157,9366436,9621227,9657454,9708165,9627208,9574532,9626155,9532830,9191826,8869199,8976604,9166185,8997631,8684437,8205140,
7896046,7692724,7585998,7615519,7705978,8081458,8402834,8716757,9048323,9189600,9325316,9487735,9545797,9469811,9483570,9525532,
9390463,9079008,8783119,8932256,9190764,8964782,8621728,8245084,7915771,7696525,7605849,7589439,7647145,8046832,8338635,8724463,
9070858,9232351,9518928,9625571,9685326,9694572,9591053,9634810,9472596,9161395,8831443,8954696,9153901,8990783,8691809,8278076,
7935612,7759259,7613739,7628521,7663728,7969490,8280906,8663779,9101381,9329107,9479349,9624253,9680690,9624098,9520661,9549690,
9303756,9003322,8720925,8782059,8953616,8793108,8608985,8126097,7837257,7600900,7520700,7528279,7601181,7694809,7957985,8355081,
8586615,8876698,8948665,8934630,8937914,8779515,8612593,8597576,8509792,8308930,8285007,8696661,8789797,8417531,8058627)

#-----------------------------------------------------------------------------------------

#ULTIMOS MIERCOLES DE HORARIO DE INVIERNO MARZO 2018
X = c(7862683,7539194,7357216,7285069,7294089,7286848,7517699,7778555,8283165,8644360,8840013,8989629,
9077733,9045176,8952611,8910423,8950400,8774206,8460669,8774347,8866346,8625582,8366715,7960311,7765074,
7515579,7356953,7298817,7236773,7421959,7827969,8122933,8645838,8916667,8998718,9136809,9310210,9364094,
9320249,9395616,9508216,9181571,8799313,9116929,9198759,8915967,8604891,8233534,7739221,7447613,7310352,
7171554,7224271,7329120,7720318,8108133,8549169,8862401,9024629,9152347,9273929,9436093,9296878,9311007,
9333464,9163386,8712439,9043948,9110923,8842492,8447510,8101035,
7738760,7480236,7384955,7274271,7274044,7417039,7788204,8155646,8583055,8897824,8949518,9036760,
9183192,9220208,9125488,9148919,9187533,9014062,8695815,9002414,9056357,8776259,8400018,8028958,
7465163,7245844,7166378,7119049,7100511,7254930,7600564,7978058,8397024,8643424,8808726,8904208,
9061038,9068454,8980685,8965085,9055732,8849873,8590100,8926881,8961504,8772185,8397095,7961595,
7363669,7167308,6981699,6869945,6966063,7102220,7489328,7884450,8292982,8561320,8660024,8728481,
8829967,8867431,8761489,8817134,8841146,8689184,8483124,8874552,8881492,8581968,8186273,7804868,
6997687,6740175,6593501,6522664,6583902,6733980,7102293,7513105,7891870,8129599,8192318,8285756,
8341230,8378603,8298699,8303203,8298714,8144534,7911373,8304268,8177217,7942977,7731498,7415210,
7014427,6829965,6716824,6667426,6743774,6909180,7309823,7745993,8124742,8353433,8467782,8466042,
8564481,8609541,8527419,8483618,8469383,8285654,8247326,8668885,8569936,8241701,7896608,7481490,
7073082,6841585,6755021,6688672,6794369,6831585,7346240,7586062,7909941,8228124,8319946,8365508,
8351838,8332429,8244228,8304662,8299866,8233794,8042732,8490623,8580051,8176824,7823812,7519158,
7203436,6973158,6818317,6761832,6835221,6936778,7338608,7758163,8131608,8411369,8479923,8513962,
8555415,8608622,8508969,8535096,8544572,8443686,8279461,8647031,8513906,8138534,7849779,7417509,
7035474,6878082,6752713,6657882,6695717,6819930,7123880,7620136,7864220,8178218,8311616,8391988,
8439888,8380336,8328957,8344347,8385059,8213130,8101448,8534936,8494139,8208302,7764342,7400258)

#PRIMEROS MIERCOLES DE HORARIO DE VERANO ABRIL 2018
Y = c(8024746,7712778,7517321,7453651,7457063,7513469,7736337,8091317,8500986,8879247,9096904,9212742,
9320006,9000254,9320699,9292964,9296340,9161342,8893853,8643769,8945712,9027930,8818646,8451947,7726058,
7430637,7183679,7102203,7166445,7175640,7572537,8128754,8455601,8749897,8861380,8980051,9094805,9087973,
9127787,9137516,9145104,9060645,8684356,8435018,8685791,8674947,8382110,8045221,7975486,7704397,7520043,
7422600,7426538,7536319,7992421,8317394,8562290,8821860,9018371,9193941,9325766,9340767,9265834,9271956,
9306724,9196252,8873910,8649801,8958124,9128008,8889641,8503083,
8205140,7896046,7692724,7585998,7615519,7705978,8081458,8402834,8716757,9048323,9189600,9325316,7811946,7016513,7795319,7965231,
7216525,9500266,9079008,8783119,8932256,9190764,8964782,8621728,7172963,6897587,6756576,6661507,6724115,6917137,7392139,7959415,
8440627,8800162,8991301,9217445,9294863,9314214,9512365,9495623,8826519,9237520,9049987,8794591,8844563,9063069,8803917,8489897,
7672670,7474604,7314037,7238062,7253019,7307352,7685233,8041707,8396295,8679775,8825815,8937129,9001848,9140952,9068098,9087406,
9065768,8846278,8491589,8241429,8365791,8519093,8351877,8048741,8146371,7874077,7630681,7529030,7525874,7575633,7822977,8180102,
8631719,8996374,9125530,9275951,9005618,8001249,9550328,9033325,7856327,9247875,8910688,8629709,8706004,8992934,8869939,8594360)

#------------------------------------------------------------------------------------------------

#CONSUMO ENERGIA ZONA BAJIO FEBRERO-MARZO 2018
X=c(12375,12824,13119,13228,14021,14049,13867,12297,13828,13864,13449,13970,13806,13975,12078,13547,
14012,12202,13874,14070,13720,11890,13333,14284,14013,13957,14499,14097,12512,13752,13364,14328,
14546,14576,14771,13205,12350,13935,14354,14419,14722,14798,12953,13939,14515,13357,12801,12141,13735,
12245,13822,14430,14687,15144,15162,13790,11789,14911,15298,15314,15273,15249,14230,12446,14899,
15478,15494,15490,15440,14557,12375,14979,15813,16029,15945,15688,14761,12671,15259,15942,16076,
16259,15773,14749,12589,13197,15467,16241,16305,16175,15266,12675,15442,16214,15704,13880,12168,13130,
8676,10915,11473,11503,11653,11613,10281,8608,11354,11834,11931,12029,12070,10698,8859,11584,
12255,12287,12201,12178,10854,8932,11665,12308,12515,12407,12244,11016,9220,11969,12545,12489,
12450,12301,10967,9036,10264,12064,12432,12512,12272,10998,9192,11142,11420,10803,9236,7815,7876,
9512,10897,11519,11839,12402,12448,11706,9990,12125,12599,12616,12400,12356,12327,10624,11842,12386,
12468,12323,12293,12102,10331,11680,12817,13140,13154,13073,12790,11101,12587,13268,13836,13776,13626,
13057,10944,11259,12906,13747,14012,14025,13547,11139,13147,13729,13428,11510,9456,10591,
14083,16586,17639,17826,17950,17871,16611,14337,17406,18273,18067,18342,18199,16910,14521,17034,
18517,18733,18498,18204,17113,15140,17807,18619,18555,18567,18275,17363,15084,17559,18680,18726,
18895,19002,17786,15247,14755,18178,19291,19313,19048,17806,15627,18076,19142,18531,16421,14209,14538)

#CONSUMO ENERGIA ZONA BAJIO ABRIL-MAYO 2018
Y=c(13787,14577,14231,14609,14517,14553,13271,14112,14709,13691,14502,14519,14169,12987,13847,14830,
12880,13976,14833,14746,12233,13383,14865,14348,14775,14832,14711,13277,14288,13398,13849,14953,
14929,14717,13119,14079,14477,13858,14168,14457,14385,12845,14109,14524,14239,14939,
15125,16096,16157,16127,16029,15017,12780,15134,15946,15597,15531,15624,14728,12247,14891,15760,
15840,16044,15749,14804,12807,15234,15890,15934,15886,15633,14854,12825,14031,13151,15299,16151,
15981,14700,12431,14844,15011,15067,14951,15079,14116,12006,14613,15412,15577,15584,
11422,12329,12545,12514,12397,11014,9153,11803,12378,12168,11861,11880,10674,8842,11694,12523,
12655,12680,12607,11328,9365,12299,12738,12766,12890,12764,11379,9454,11386,10920,12259,12538,
12524,10919,8883,11727,12005,11986,11104,11835,10961,9107,11716,12090,12263,12322,
12446,13978,14157,14266,14146,13546,11502,13094,14005,13364,13275,13337,12626,10792,12597,13667,
13779,13859,13902,13204,11216,13038,13796,13448,13272,13491,12605,10930,12205,11144,12086,13151,
13237,12474,10254,11744,12817,12900,12216,12516,12401,11030,12600,13268,13215,13033,
17472,19037,19056,19201,19190,18200,15630,18160,19283,18797,18755,18694,17731,15165,17756,19187,
19331,19357,19181,18040,15791,18221,19358,19041,19421,19237,17887,15604,17293,15417,17993,19081,
19045,17722,15221,17809,18636,18620,18431,18692,17924,15393,18034,19275,19297,19370)

#SUMANDO CADA DIA DE CADA REGI?N OBTENEMOS---------------------------------------
X = c(56891, 65044, 68180, 69083, 71170, 71143, 66255, 57021, 69624, 71868, 71377, 72014,
71680, 68140, 58528, 68906, 72648, 71184, 72386, 72185, 68346, 58668, 69464, 73841,
74252, 74030, 73779, 70027, 60588, 71126, 73799, 75455, 75926, 75278, 71330, 61021,
61825, 72550, 76065, 76561, 76242, 72415, 61586, 71746, 75020, 71823, 63848, 55789, 59870)

Y = c(70252, 76017, 76146, 76717, 76279, 72330, 62336, 72303, 76321, 73617, 73924, 74054,
69928, 66033, 70785, 75967, 74485, 75916, 76272, 72122, 61412, 72175, 76647, 75537,
77244, 75957, 65436, 62090, 69203, 64030, 71486, 78874, 75716, 70532, 59908, 70203,
72946, 76431, 70870, 72579, 69787, 60381, 71072, 74569, 74591, 66489, 67419, 65122, 78248)

#MIERCOLES DE CADA REGION
#INVIERNO
X=c(12829,12618,13228,13449,
12202,13357,13128,12604,12360,12323,
14520,14783,14687,15314,
15494,15704,14512,13857,13938,13637,
11850,11843,11503,11931,
12287,10803,11836,11772,11525,10916,
11534,11685,11839,12616,
12468,13428,11803,11816,12107,11401,
17684,17514,17826,18067,
18733,18531,17410,17738,17786,17066)

#VERANO
Y=c(14231,13691,12880,14348,
13849,13858,14239,
16157,15597,15840,15934,
15299,15067,15577,
12545,12168,12655,12766,
12259,11986,12263,
14157,13364,13779,13448,
12086,12900,13215,
19056,18797,19331,19041,
17993,18620,19297)
X1<-c()
ene=10
for(i in 1:ene)	{
	X1[i]=X[i]+X[i+ene]+X[i+ene*2]+X[i+ene*3]+X[i+ene*4]
}

Y1<-c()
for(i in 1:7)	{
	Y1[i]=Y[i]+Y[i+7]+Y[i+7*2]+Y[i+7*3]+Y[i+7*4]
}
##################################################################################################################
#--     PERFILES DE THETA Y SIGMA     --#

X = X1/1000
Y = Y1/1000
#(a)

# estadisticas suficientes
T11<- sum(X)
T21 <- sum(X*X)
T12<- sum(Y)
T22 <- sum(Y*Y)

n = length(X)
m = length(Y)
th1_gorro = T11/n
th2_gorro = T12/m
delta_gorro = th2_gorro - th1_gorro
sg1_gorro = (T21/n-T11^2/n^2)^(1/2)
sg2_gorro = (T22/m-T12^2/m^2)^(1/2)
ro_gorro = sg2_gorro/sg1_gorro
alfa = 1-0.95

#Para theta <--------------------------------------------------------------------------------------------

#Nivel de verosimilitud de peruanos de theta

C(n, alfa)
Nivel_per = C(n, alfa)
#Nivel_per = 0.1465
Confianza(n,Nivel_per)
#El intervalo es [th1,th2]
A = th1_gorro - sg1_gorro*(Nivel_per^(-2/n)-1)^(1/2)
B = th1_gorro + sg1_gorro*(Nivel_per^(-2/n)-1)^(1/2)
c(A, B)
I1 = c(A,B)

#Nivel de verosimilitud de gringos

C(m, alfa)
Nivel_gri = C(m, alfa)
#Nivel_gri = 0.1465
Confianza(m,Nivel_gri) 
#El intervalo es [th1,th2]
A = th2_gorro - sg2_gorro*(Nivel_gri^(-2/m)-1)^(1/2)
B = th2_gorro + sg2_gorro*(Nivel_gri^(-2/m)-1)^(1/2)
c(A, B)
I2 = c(A,B)


#Graficamos los resultados
lim1=66
lim2=77
X2 <- seq(lim1,lim2,length=1000)
plot(X2,Rp_norm(X2,T11,T21,n), type="l", 
	xlab= expression(theta), ylab=expression(R[p](theta)),xaxs="i",yaxs="i",
	xaxt="n",yaxt="n",las=1, col="blue", main="Consumo de energ?a (Mw)")
par(new=TRUE)
plot(X2,Rp_norm(X2,T12,T22,m), type="l", 
	xlab= expression(theta), ylab=expression(R[p](theta)),xaxt="n",yaxt="n",
  	xaxs="i",yaxs="i",las=1, col="red", main="Consumo de energ?a (Mw)")
points(I1, c(Nivel_per,Nivel_per),pch=16,col="red") 
lines(I1, c(Nivel_per,Nivel_per),lty=2, col="red") #lty determina el estilo de la linea
points(I2, c(Nivel_gri,Nivel_gri),pch=16,col="blue") 
lines(I2, c(Nivel_gri,Nivel_gri),lty=2, col="blue")
#Las dos instrucciones anteriores servir?n para marcar el intervalo de verosimilitud en la grafica
abline(v=th1_gorro,col="black",lty=3)#Mostramos con una linea vertical (de ah? la v) la localicaci?n del estimador de maxima verosimilitud
points(th1_gorro,Nivel_per,pch=18,col="blue")#Mostramos con un punto el verdadero valor de $theta$. ?Lo contiene el intervalo?
abline(v=th2_gorro,col="black",lty=3)#Mostramos con una linea vertical (de ah? la v) la localicaci?n del estimador de maxima verosimilitud
points(th2_gorro,Nivel_gri,pch=18,col="red")#Mostramos con un punto el verdadero valor de $theta$. ?Lo contiene el intervalo?
legend(lim1,1, c("Invierno","Verano"),pch=16:16,col=c("blue","red"))

axis(side=2,at= seq(0,1,by=0.1),las=1,cex.axis=0.7)
axis(side=1,at=seq(lim1,lim2,by=1),las=1)
grid(nx = (lim2-lim1)/1, ny =(1-0)/.1 , col = "lightgray", lty = "dotted",
     lwd = par("lwd"), equilogs = TRUE)



#Para sigma <------------------------------------------------------------------------------------

alfa = 1-0.95
#Nivel_per = C_var(n, alfa)
Nivel_per=0.1040432
#Nivel_per=0.1465
#C_var(n,alfa)
#Nivel_gri = C_var(m, alfa)
Nivel_gri = 0.0890952
#Nivel_gri=0.1465
#C_var(m,alfa)
Confianza_var(n,Nivel_per)
Confianza_var(m,Nivel_gri)

#El intervalo para peruanos

H = T21-T11^2/n

#A = ((sg1_gorro)^(2/3)/(1+(-4*log(Nivel_per)/(9*n))^(1/2)))^3
#B = ((sg1_gorro)^(2/3)/(1-(-4*log(Nivel_per)/(9*n))^(1/2)))^3

A = (27*H*n^(1/2)/(3*n^(1/2)+(-4*log(Nivel_per))^(1/2))^3)^(1/2)
B = (27*H*n^(1/2)/(3*n^(1/2)-(-4*log(Nivel_per))^(1/2))^3)^(1/2)
c(A, B)
I1 = c(A,B)

#El intervalo para gringos

H = T22-T12^2/m

#A = ((sg2_gorro)^(2/3)/(1+(-4*log(Nivel_gri)/(9*m))^(1/2)))^3
#B = ((sg2_gorro)^(2/3)/(1-(-4*log(Nivel_gri)/(9*m))^(1/2)))^3

A = (27*H*m^(1/2)/(3*m^(1/2)+(-4*log(Nivel_gri))^(1/2))^3)^(1/2)
B = (27*H*m^(1/2)/(3*m^(1/2)-(-4*log(Nivel_gri))^(1/2))^3)^(1/2)
c(A, B)
I2 = c(A,B)

#Graficamos la perfil de la varianza
lims1=0.5
lims2=5
X2 <- seq(lims1,lims2,length=1000)
plot(X2,Rp_var_norm(X2,T11,T21,n), type="l", 
	xlab= expression(sigma), ylab=expression(R[p](sigma)),xaxt="n",yaxt="n",
  	xaxs="i",yaxs="i",las=1, col="blue", main="Consumo de energ?a (Mw)")
par(new=TRUE)
plot(X2,Rp_var_norm(X2,T12,T22,m), type="l", 
	xlab= expression(sigma), ylab=expression(R[p](sigma)),xaxt="n",yaxt="n",
  	xaxs="i",yaxs="i",las=1, col="red", main="Consumo de energ?a (Mw)")
points(I1, c(Nivel_per,Nivel_per),pch=16,col="red") 
lines(I1, c(Nivel_per,Nivel_per),lty=2, col="red") #lty determina el estilo de la linea
points(I2, c(Nivel_gri,Nivel_gri),pch=16,col="blue") 
lines(I2, c(Nivel_gri,Nivel_gri),lty=2, col="blue")
#Las dos instrucciones anteriores servir?n para marcar el intervalo de verosimilitud en la grafica
abline(v=sg1_gorro,col="black",lty=3)#Mostramos con una linea vertical (de ah? la v) la localicaci?n del estimador de maxima verosimilitud
points(sg1_gorro,Nivel_per,pch=18,col="blue")#Mostramos con un punto el verdadero valor de $theta$. ?Lo contiene el intervalo?
abline(v=sg2_gorro,col="black",lty=3)#Mostramos con una linea vertical (de ah? la v) la localicaci?n del estimador de maxima verosimilitud
points(sg2_gorro,Nivel_gri,pch=18,col="red")#Mostramos con un punto el verdadero valor de $theta$. ?Lo contiene el intervalo?
legend(lims1,1, c("Invierno","Verano"),pch=16:16,col=c("blue","red"))

axis(side=2,at= seq(0,1,by=0.1),las=1,cex.axis=0.7)
axis(side=1,at=seq(lims1,lims2,by=.5),las=1)
grid(nx = (lims2-lims1)/.5, ny =(1-0)/.1 , col = "lightgray", lty = "dotted",
     lwd = par("lwd"), equilogs = TRUE)




########################################################################################################
#--    CONTORNOS THETA Y SIGMA     --#

Mus <- seq(lim1,lim2,length=100)
Sigmas<- seq(lims1,lims2,length=100)
Mus2 <- seq(lim1,lim2,length=100)
Sigmas2<- seq(lims1,lims2,length=100)

mu_gorro= th1_gorro
sigma_gorro= sg1_gorro
mu_gorro2= th2_gorro
sigma_gorro2= sg2_gorro

#Agregamos los estimadores de m?xima verosimilitud a la lista
Mus <- c(Mus, mu_gorro) 
Sigmas <- c(Sigmas, sigma_gorro)
Mus2 <- c(Mus2, mu_gorro2) 
Sigmas2 <- c(Sigmas2, sigma_gorro2)

#La funci?n contour que se usa m?s adelante s?lo acepta datos ordenados para los ejes x y y
Mus<- sort(Mus) 
Sigmas<- sort(Sigmas)
Mus2<- sort(Mus2) 
Sigmas2<- sort(Sigmas2)

Z1<- matrix(nrow = 101, ncol = 101)

for (i in 1:101){
  for (j in 1:101){
    Z1[i,j]<- R(Mus[i], Sigmas[j], T11, T21, n)
  }
}

Z2<- matrix(nrow = 101, ncol = 101)

for (i in 1:101){
  for (j in 1:101){
    Z2[i,j]<- R(Mus2[i], Sigmas2[j], T12, T22, m)
  }
}

#Graficamos la primera gr?fica de contornos

contour(Mus, Sigmas, Z1, #Eje x, Eje y, finalmente eje Z(La funci?n evaluada)
        xlab= expression(theta), ylab= expression(sigma),
        levels=c(0.05, 0.1, 0.1465, 0.5, 0.8, 1), #Qu? niveles graficar?
        labels=c(0.05, 0.1, 0.1465, 0.5, 0.8, 1), #Qu? etiquetas llevaran esos niveles
        labcex=1,
        cex.lab=1,
        xaxs="i",yaxs="i",
        cex.axis=1,
	  col = "blue")

lines( Mu_gorro(Sigmas,T11, T21, n), Sigmas, col="black", lty=2) 
lines( Mus, Sigma_gorro(Mus,T11, T21, n), col="black", lty=2)

# Y luego agregamos la segunda con la misma instrucci?n, agregando add=TRUE al final

contour(Mus2, Sigmas2, Z2, #Eje x, Eje y, finalmente eje Z(La funci?n evaluada)
        xlab= expression(theta), ylab= expression(sigma),
        levels=c(0.05, 0.1, 0.1465, 0.5, 0.8, 1), #Qu? niveles graficar?
        labels=c(0.05, 0.1, 0.1465, 0.5, 0.8, 1), #Qu? etiquetas llevaran esos niveles
        labcex=1,
        cex.lab=1,
        xaxs="i",yaxs="i",
        cex.axis=1,
        col = "red", #Diferente color para que se diferencias
        add = TRUE)


lines( Mu_gorro(Sigmas,T12, T22, m), Sigmas, col="black", lty=2) 
lines( Mus, Sigma_gorro(Mus,T12, T22, m), col="black", lty=2)
legend(lim1,lims2, c("Invierno","Verano"),pch=16:16,col=c("blue","red"))

##############################################################################################################
#--     PERFIL DE RO = SIGMA2/SIGMA1     --#

T1= sum(X)
T2= sum(X^2)
T3= sum(Y)
T4= sum(Y^2)
N= length(X)
M= length(Y)

#--------------------------------Gr?fica de punto 6-------------------------------
limr1=0
limr2=5
Rhos<- seq(limr1,limr2, length=1000)

plot (Rhos,Rp_rho(Rhos, T1, T2, T3, T4, N, M), type="l", 
      xlab= expression(rho), ylab=expression(R[p](rho)),#en expression [] significa sub?ndice
      xaxs="i",yaxs="i",
      xaxt="n",yaxt="n", # Recuerda que esto es para quitar las marcas de los ejes preestablecidas y colocar las tuyas con axis
      las=1)

axis(side=2,at= seq(0,1,by=0.1),las=1,cex.axis=0.7)
axis(side=1,at=seq(limr1,limr2,by=1),las=1)
grid(nx = (limr2-limr1)/1, ny =(1-0)/0.1 , col = "lightgray", lty = "dotted",
     lwd = par("lwd"), equilogs = TRUE)
abline(v=1,lty=2,col="blue")

#-------------------Calculo de c de manera numerica con busqueda binaria--------------

#En este pedazo se procede a calcular el nivel c que est? asociado a una confianza del 95% segun
# el pivotal F de Fisher propuesto en la gu?a. Lo que se hace es calcular la probabilidad asociada
# al nivel cactual, y mientras este demasiado lejano a 0.95, se sube o se baja segun sea necesario.

csup= 0.4 # Se buscar? el nivel de verosimilitud entre csup y cinf
cinf= 0.02
A= (M-1)*Hx(T1,T2,N)/((N-1)*Ky(T3,T4,M))
rho_g= rho_emv(T1,T2,T3,T4,N,M)

cactual= (csup+cinf)/2
#cactual = 0.2585

rho1= uniroot(rp_rho_0,c(0.00000001,rho_g), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root 
rho2= uniroot(rp_rho_0,c(rho_g,20), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root

ProbIntervalo= pf(A*rho2,N-1,M-1)-pf(A*rho1,N-1,M-1)

while(abs(ProbIntervalo-0.90)>0.000001){
  if (ProbIntervalo>0.90){ #Si la probabilidad es mayor a 0.95, se debe subir el nivel del intervalo
    cinf=cactual
    cactual= (csup+cinf)/2
    
    print("entra1")
    rho1= uniroot(rp_rho_0,c(0.00000001,rho_g), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root 
    rho2= uniroot(rp_rho_0,c(rho_g,20), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root
    
    
    ProbIntervalo= pf(A*rho2,N-1,M-1)-pf(A*rho1,N-1,M-1)
  }else { # Si la probabilidad es menor, se debe subir el nivel del intervalo
    csup=cactual
    cactual= (csup+cinf)/2
    
    print("entra2")
    rho1= uniroot(rp_rho_0,c(0.00000001,rho_g), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root 
    rho2= uniroot(rp_rho_0,c(rho_g,20), t1=T1, t2=T2, t3=T3, t4= T4, n=N, m=M, c=log(cactual))$root
    
    ProbIntervalo= pf(A*rho2,N-1,M-1)-pf(A*rho1,N-1,M-1)
  }
  print(cactual)
}

#Encontrando cactual, ya s?lo queda graficar el intervalo asociado

points(c(rho1,rho2),c(cactual,cactual),pch=16,col="red")
lines(c(rho1,rho2),c(cactual,cactual),lty=2,col="red")

#-------------------------Grafica punto 7--------------------------
limd1=-1
limd2=9
Deltas<- seq(limd1,limd2,length=1000)


plot (Deltas,Rp_delta(Deltas, T1, T2, T3, T4, N, M), type="l", 
      xlab= expression(delta), ylab=expression(R[p](delta)),#en expression [] significa sub?ndice
      xaxs="i",yaxs="i",
      xaxt="n",yaxt="n", # Recuerda que esto es para quitar las marcas de los ejes preestablecidas y colocar las tuyas con axis
      las=1)

axis(side=2,at= seq(0,1,by=0.1),las=1,cex.axis=0.7)
axis(side=1,at=seq(limd1,limd2,by=1),las=1)
grid(nx = (limd2-limd1)/1, ny =(1-0)/0.1 , col = "lightgray", lty = "dotted",
     lwd = par("lwd"), equilogs = TRUE)
abline(v=0,lty=2,col="blue")

#-----------Calculo de c---------------

A2= Hx(T1,T2, N)/(N*(N-1)) + Ky(T3, T4, M)/(M*(M-1))
denom= Hx(T1,T2, N)*Hx(T1,T2, N)/((N^2)*((N-1)^3))  +  Ky(T3, T4, M)*Ky(T3, T4, M)/((M^2)*((M-1)^3))

Tsw = delta_emv(T1,T2,T3,T4,N,M)/sqrt(A2)
grados_libertad= floor(A2*A2/denom)
dt(Tsw, grados_libertad, log = F)

c= ((qt(0.0245604, grados_libertad)^2)/(grados_libertad) + 1)^(-(grados_libertad+1)/2) # 0.025 es para que la probabilidad del intervalo sea 0.95
#c=0.1465

delta1= delta_emv(T1,T2,T3,T4,N,M) - sqrt(grados_libertad*A2*((c^(-2/(grados_libertad+1)))-1))
delta2= delta_emv(T1,T2,T3,T4,N,M) + sqrt(grados_libertad*A2*((c^(-2/(grados_libertad+1)))-1))
Confianza(grados_libertad,c)
#-------Lo agregamos a la gr?fica---------

points(c(delta1,delta2),c(c,c),pch=16,col="red")
lines(c(delta1,delta2),c(c,c),lty=2,col="red")

#-------------------------Grafica CRUCIAL----------------------------------------------

Deltas= seq(limd1,limd2,length=100)
Phis= seq(-3,2.5, length=100)

Z1<- matrix(nrow = 100, ncol = 100)

for (i in 1:100){
  for (j in 1:100){
    Z1[i,j]<- Rp_conjunto(exp(Phis[j]),Deltas[i], T1, T2, T3, T4, N, M)
  }
}

#Luego, para graficar los resultados, utilizamos la funci?n contour

contour(Deltas, Phis, Z1, #Eje x, Eje y, finalmente eje Z(La funci?n evaluada)
        xlab= expression(delta), ylab= expression(log(rho)),
        levels=c(0.5,0.2,0.1,0.05,0.03,0.01,c), #Qu? niveles graficar?
        labels=c(0.5,0.2,0.1,0.05,0.03,0.01,"c"), #Qu? etiquetas llevaran esos niveles
        labcex=1,
        cex.lab=1,
        xaxs="i",yaxs="i",
        cex.axis=1)

points(c(delta_emv(T1,T2,T3,T4,N,M)),c(log(rho_emv(T1,T2,T3,T4,N,M))), pch="*")
abline(v=0, col="blue")
abline(h=0, col="blue")
abline(h=log(rho1), col="blue")
abline(h=log(rho2), col="blue")


#--------------------------------Solo faltan las rectas de intervalos equiespaciadas para valores entre rho1 y rho2-----------------

Phis2<- seq(log(rho1),log(rho2),length=20)
deltas1 <- seq(1:20)
deltas2 <- seq(1:20)

for (i in 1:20){
  D_rho= (1/N + exp(Phis2[i])/M)*(1/(N+M-2))*(Hx(T1,T2,N)+Ky(T3,T4,M)/exp(Phis2[i]))
  
  delta1_temp= delta_emv(T1,T2,T3,T4,N,M) - qt(0.025, N+M-2)*sqrt(D_rho)
  delta2_temp= delta_emv(T1,T2,T3,T4,N,M) + qt(0.025, N+M-2)*sqrt(D_rho)
  lines(c(delta1_temp,delta2_temp),c(Phis2[i],Phis2[i]), col="red",lty=2)
  deltas1[i]=delta1_temp
  deltas2[i]=delta2_temp
}

for(i in 1:19){
	lines(c(deltas1[i],deltas1[i+1]),c(Phis2[i],Phis2[i+1]),col="red")
	lines(c(deltas2[i],deltas2[i+1]),c(Phis2[i],Phis2[i+1]),col="red")
}

